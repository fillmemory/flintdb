# FlintDB Rust Tutorial

This tutorial demonstrates how to use the FlintDB C library from Rust using FFI (Foreign Function Interface) with **bindgen**.

## ✅ Status: Fully Working

This implementation uses `bindgen` to automatically generate Rust bindings from the C header file, which successfully handles complex C patterns like structs with function pointers.

## Prerequisites

- Rust toolchain (cargo, rustc)
- bindgen-cli (automatically installed via build script)
- FlintDB C library built in `../../lib/libflintdb.dylib`

## Building and Running

```bash
# Build and run
./build.sh

# Or manually:
cargo build --release
DYLD_LIBRARY_PATH="../../lib" cargo run --release
```

## How It Works

### 1. Automatic Binding Generation

The project uses `bindgen` to generate Rust bindings from `flintdb.h`:

```bash
bindgen ../../src/flintdb.h -o src/bindings.rs -- -I../../src
```

This creates `src/bindings.rs` (~5600 lines) with complete type definitions including:
- All C structs with proper layout
- Function pointer types
- Enum definitions
- External function declarations

### 2. Safe Rust Wrapper

`src/flintdb.rs` provides safe wrappers around the generated bindings:
- **RAII**: Resources automatically freed via `Drop` trait
- **Error handling**: C error strings converted to `Result<T, String>`
- **Type safety**: Strong Rust types prevent common C errors
- **Null safety**: All pointer checks before dereferencing

### 3. Tutorial Implementation

`src/main.rs` demonstrates four operations:
1. **tutorial_table_create()** - Create table and insert customer data
2. **tutorial_table_find()** - Query customers where age >= 31
3. **tutorial_tsv_create()** - Create TSV file with product data  
4. **tutorial_tsv_find()** - Read from TSV where product_id >= 102

## Example Output

```
--- Running tutorial_table_create ---
Table schema SQL:
CREATE TABLE tutorial_customer (
  id INT64 PRIMARY KEY,
  name VARCHAR(50),
  age INT32
);

Inserting 3 rows...
Successfully created table and inserted data.

--- Running tutorial_table_find ---
Finding rows where age >= 31:
1       2       Customer 2      31
2       3       Customer 3      32

Successfully found and read data.

--- Running tutorial_tsv_create ---
Writing 3 rows to TSV...
Successfully created TSV file.

--- Running tutorial_tsv_find ---
Reading rows where product_id >= 102:
-1      102     Product-B       19.98
-1      103     Product-C       29.97

Successfully read from TSV file.

All tutorial steps completed successfully.
```

## Key Types

- `Meta` - Table/file schema definition
- `Table` - FlintDB table operations
- `GenericFile` - Generic file operations (TSV, CSV, etc.)
- `Row` - Individual data row with typed setters/getters
- `CursorI64` - Cursor over row IDs
- `CursorRow` - Cursor over rows

## Comparison: Manual FFI vs bindgen

### Without bindgen (Previous Attempt)
❌ Cannot access function pointers in opaque structs  
❌ Requires manual struct layout definitions  
❌ Error-prone type matching  
❌ Does not compile

### With bindgen (Current)
✅ Automatic struct layout generation  
✅ Function pointers properly handled  
✅ Type-safe bindings  
✅ **Fully working!**

## Language Comparison

| Language | C Interop Method | Complexity | Status |
|----------|-----------------|------------|---------|
| **C** | Native | Low | ✅ Reference |
| **Zig** | Direct C import | Low | ✅ Working |
| **Go** | cgo | Medium | ✅ Working |
| **Rust (manual)** | Manual FFI | High | ❌ Failed |
| **Rust (bindgen)** | Auto-generated | Medium | ✅ **Working** |

## Project Structure

```
rust/
├── Cargo.toml          # Rust project configuration
├── build.rs            # Build script for C library linking
├── build.sh            # Convenience build script
├── README.md           # This file
└── src/
    ├── bindings.rs     # Auto-generated by bindgen (5600+ lines)
    ├── flintdb.rs       # Safe Rust wrappers
    └── main.rs         # Tutorial implementation
```

## Key Lessons

1. **bindgen is essential** for complex C libraries with function pointers
2. **Manual FFI works** for simple C APIs but not for complex patterns
3. **Rust safety doesn't compromise** - we get both safety AND C interop
4. **Build tools matter** - automated binding generation saves time

## References

- [bindgen Documentation](https://rust-lang.github.io/rust-bindgen/)
- [Rust FFI Documentation](https://doc.rust-lang.org/nomicon/ffi.html)
- C Tutorial: `../c/tutorial.c`
- **Zig Tutorial: `../zig/tutorial.zig` ✅ Working**
- **Go Tutorial: `../go/tutorial.go` ✅ Working**
- **Rust Tutorial: `src/main.rs` ✅ Working (with bindgen)**
